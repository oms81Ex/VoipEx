<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoipEx 상세 서버 아키텍처</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1, h2, h3 {
            color: #2c3e50;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 40px;
            font-size: 2.5em;
        }
        
        h2 {
            margin-top: 40px;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        h3 {
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.3em;
            color: #34495e;
        }
        
        .architecture-diagram {
            margin: 30px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            overflow-x: auto;
        }
        
        svg {
            width: 100%;
            height: auto;
            min-height: 400px;
        }
        
        .service-box {
            fill: #3498db;
            stroke: #2980b9;
            stroke-width: 2;
            rx: 5;
        }
        
        .client-box {
            fill: #9b59b6;
            stroke: #8e44ad;
            stroke-width: 2;
            rx: 5;
        }
        
        .data-box {
            fill: #e74c3c;
            stroke: #c0392b;
            stroke-width: 2;
            rx: 5;
        }
        
        .gateway-box {
            fill: #f39c12;
            stroke: #d68910;
            stroke-width: 2;
            rx: 5;
        }
        
        .media-box {
            fill: #2ecc71;
            stroke: #27ae60;
            stroke-width: 2;
            rx: 5;
        }
        
        .monitor-box {
            fill: #95a5a6;
            stroke: #7f8c8d;
            stroke-width: 2;
            rx: 5;
        }
        
        .text-label {
            fill: white;
            font-size: 14px;
            font-weight: 600;
            text-anchor: middle;
        }
        
        .port-label {
            fill: white;
            font-size: 11px;
            text-anchor: middle;
        }
        
        .arrow {
            stroke: #34495e;
            stroke-width: 2;
            marker-end: url(#arrowhead);
        }
        
        .arrow-websocket {
            stroke: #e74c3c;
            stroke-width: 2;
            stroke-dasharray: 5,5;
            marker-end: url(#arrowhead-ws);
        }
        
        .arrow-media {
            stroke: #2ecc71;
            stroke-width: 3;
            marker-end: url(#arrowhead-media);
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .service-detail {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            background-color: #fafafa;
        }
        
        .service-detail h4 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.2em;
        }
        
        .tech-stack {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .tech-stack strong {
            color: #1976d2;
        }
        
        .api-endpoints {
            background-color: #f3e5f5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .api-endpoints code {
            background-color: #e1bee7;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .sequence-diagram {
            background-color: #fff3e0;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .data-model {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .data-model pre {
            background-color: #c8e6c9;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        
        .network-info {
            background-color: #fff8e1;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: #3498db;
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .flow-step {
            background-color: #f0f0f0;
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #3498db;
            position: relative;
        }
        
        .flow-step::before {
            content: attr(data-step);
            position: absolute;
            left: -30px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #3498db;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .legend-box {
            width: 30px;
            height: 20px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>VoipEx 상세 서버 아키텍처 및 설계도</h1>
        
        <h2>1. VoipEx 시스템 컴포넌트</h2>
        <div class="architecture-diagram">
            <svg viewBox="0 0 1200 900" xmlns="http://www.w3.org/2000/svg">
                <!-- Arrow markers -->
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#34495e" />
                    </marker>
                    <marker id="arrowhead-ws" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#e74c3c" />
                    </marker>
                    <marker id="arrowhead-media" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#2ecc71" />
                    </marker>
                </defs>
                
                <!-- Title -->
                <text x="600" y="30" style="font-size: 24px; font-weight: bold; text-anchor: middle; fill: #2c3e50;">VoipEx 시스템 컴포넌트</text>
                
                <!-- Client Layer Box -->
                <rect x="40" y="50" width="370" height="100" fill="none" stroke="#9b59b6" stroke-width="2" stroke-dasharray="5,5" rx="10"/>
                <text x="50" y="70" style="font-size: 14px; font-weight: bold; fill: #9b59b6;">Client Layer</text>
                
                <!-- Client Components -->
                <rect x="60" y="80" width="150" height="50" class="client-box"/>
                <text x="135" y="105" class="text-label">React Web App</text>
                
                <rect x="240" y="80" width="150" height="50" class="client-box"/>
                <text x="315" y="105" class="text-label">Mobile App</text>
                
                <!-- Gateway Layer Box -->
                <rect x="40" y="180" width="370" height="120" fill="none" stroke="#f39c12" stroke-width="2" stroke-dasharray="5,5" rx="10"/>
                <text x="50" y="200" style="font-size: 14px; font-weight: bold; fill: #f39c12;">Gateway Layer</text>
                
                <!-- Gateway Components -->
                <rect x="150" y="210" width="150" height="30" class="gateway-box"/>
                <text x="225" y="230" class="text-label">Nginx</text>
                
                <rect x="150" y="250" width="150" height="40" class="gateway-box"/>
                <text x="225" y="275" class="text-label">API Gateway</text>
                
                <!-- Service Layer Box -->
                <rect x="40" y="330" width="820" height="100" fill="none" stroke="#3498db" stroke-width="2" stroke-dasharray="5,5" rx="10"/>
                <text x="50" y="350" style="font-size: 14px; font-weight: bold; fill: #3498db;">Service Layer</text>
                
                <!-- Service Components -->
                <rect x="60" y="360" width="120" height="50" class="service-box"/>
                <text x="120" y="385" class="text-label">Call Service</text>
                
                <rect x="200" y="360" width="120" height="50" class="service-box"/>
                <text x="260" y="385" class="text-label">User Service</text>
                
                <rect x="340" y="360" width="120" height="50" class="service-box"/>
                <text x="400" y="385" class="text-label">Auth Service</text>
                
                <rect x="480" y="360" width="120" height="50" class="service-box"/>
                <text x="540" y="375" class="text-label">Signaling</text>
                <text x="540" y="395" class="text-label">Service</text>
                
                <rect x="620" y="360" width="120" height="50" class="service-box"/>
                <text x="680" y="385" class="text-label">Media Service</text>
                
                <rect x="760" y="360" width="120" height="50" class="service-box"/>
                <text x="820" y="385" class="text-label">Room Service</text>
                
                <!-- Data Layer Box -->
                <rect x="40" y="460" width="370" height="120" fill="none" stroke="#e74c3c" stroke-width="2" stroke-dasharray="5,5" rx="10"/>
                <text x="50" y="480" style="font-size: 14px; font-weight: bold; fill: #e74c3c;">Data Layer</text>
                
                <!-- Data Components -->
                <rect x="100" y="500" width="100" height="60" class="data-box"/>
                <text x="150" y="530" class="text-label">MongoDB</text>
                
                <rect x="250" y="500" width="100" height="60" class="data-box"/>
                <text x="300" y="530" class="text-label">Redis</text>
                
                <!-- Media Processing Box -->
                <rect x="440" y="460" width="420" height="120" fill="none" stroke="#2ecc71" stroke-width="2" stroke-dasharray="5,5" rx="10"/>
                <text x="450" y="480" style="font-size: 14px; font-weight: bold; fill: #2ecc71;">Media Processing</text>
                
                <!-- Media Components -->
                <rect x="480" y="500" width="160" height="60" class="media-box"/>
                <text x="560" y="520" class="text-label">Kurento Media</text>
                <text x="560" y="540" class="text-label">Server</text>
                
                <rect x="680" y="500" width="160" height="60" class="media-box"/>
                <text x="760" y="520" class="text-label">Coturn TURN</text>
                <text x="760" y="540" class="text-label">Server</text>
                
                <!-- Monitoring Box -->
                <rect x="890" y="180" width="280" height="250" fill="none" stroke="#95a5a6" stroke-width="2" stroke-dasharray="5,5" rx="10"/>
                <text x="900" y="200" style="font-size: 14px; font-weight: bold; fill: #95a5a6;">Monitoring</text>
                
                <!-- Monitoring Components -->
                <rect x="960" y="220" width="140" height="60" class="monitor-box"/>
                <text x="1030" y="250" class="text-label">Grafana</text>
                
                <rect x="960" y="340" width="140" height="60" class="monitor-box"/>
                <text x="1030" y="370" class="text-label">Prometheus</text>
                
                <!-- NAT 순회를 위한 STUN/TURN 서버 Note -->
                <rect x="650" y="600" width="200" height="50" fill="#fff8e1" stroke="#f39c12" stroke-width="1" rx="5"/>
                <text x="750" y="620" style="font-size: 12px; text-anchor: middle; fill: #333;">NAT 순회를 위한</text>
                <text x="750" y="635" style="font-size: 12px; text-anchor: middle; fill: #333;">STUN/TURN 서버</text>
                
                <!-- Connections -->
                <!-- Client to Nginx -->
                <line x1="135" y1="130" x2="225" y2="210" class="arrow"/>
                <line x1="315" y1="130" x2="225" y2="210" class="arrow"/>
                
                <!-- Nginx to API Gateway -->
                <line x1="225" y1="240" x2="225" y2="250" class="arrow"/>
                
                <!-- Nginx to Signaling (WebSocket) -->
                <line x1="300" y1="230" x2="540" y2="360" class="arrow-websocket"/>
                <text x="420" y="280" style="font-size: 11px; fill: #e74c3c;">WebSocket</text>
                
                <!-- API Gateway to Services -->
                <line x1="225" y1="290" x2="120" y2="360" class="arrow"/>
                <line x1="225" y1="290" x2="260" y2="360" class="arrow"/>
                <line x1="225" y1="290" x2="400" y2="360" class="arrow"/>
                
                <!-- Services to Data Layer -->
                <line x1="120" y1="410" x2="150" y2="500" class="arrow"/>
                <line x1="260" y1="410" x2="150" y2="500" class="arrow"/>
                <line x1="400" y1="410" x2="150" y2="500" class="arrow"/>
                <line x1="400" y1="410" x2="300" y2="500" class="arrow"/>
                <line x1="540" y1="410" x2="300" y2="500" class="arrow"/>
                <line x1="680" y1="410" x2="300" y2="500" class="arrow"/>
                
                <!-- Media Service to Kurento -->
                <line x1="680" y1="410" x2="560" y2="500" class="arrow-media"/>
                
                <!-- Coturn connection line -->
                <line x1="760" y1="560" x2="750" y2="600" stroke="#f39c12" stroke-width="1" stroke-dasharray="3,3"/>
                
                <!-- Monitoring connections -->
                <line x1="1030" y1="280" x2="1030" y2="340" class="arrow"/>
                <line x1="960" y1="370" x2="820" y2="385" class="arrow"/>
                <line x1="960" y1="370" x2="680" y2="385" class="arrow"/>
                <line x1="960" y1="370" x2="540" y2="385" class="arrow"/>
            </svg>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-box" style="background-color: #9b59b6;"></div>
                <span>Client Layer</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background-color: #f39c12;"></div>
                <span>Gateway Layer</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background-color: #3498db;"></div>
                <span>Service Layer</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background-color: #2ecc71;"></div>
                <span>Media Processing</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background-color: #e74c3c;"></div>
                <span>Data Layer</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background-color: #95a5a6;"></div>
                <span>Monitoring</span>
            </div>
        </div>
        
        <h2>2. 전체 시스템 아키텍처 (포트 정보 포함)</h2>
        <div class="architecture-diagram">
            <svg viewBox="0 0 1200 800" xmlns="http://www.w3.org/2000/svg">
                <!-- Arrow markers -->
                <defs>
                    <marker id="arrowhead2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#34495e" />
                    </marker>
                    <marker id="arrowhead-ws2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#e74c3c" />
                    </marker>
                    <marker id="arrowhead-media2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#2ecc71" />
                    </marker>
                </defs>
                
                <!-- Client Layer -->
                <rect x="50" y="20" width="150" height="60" class="client-box"/>
                <text x="125" y="45" class="text-label">React Frontend</text>
                <text x="125" y="65" class="port-label">:80</text>
                
                <rect x="250" y="20" width="150" height="60" class="client-box"/>
                <text x="325" y="45" class="text-label">Mobile App</text>
                <text x="325" y="65" class="port-label">iOS/Android</text>
                
                <!-- Gateway Layer -->
                <rect x="150" y="120" width="150" height="60" class="gateway-box"/>
                <text x="225" y="145" class="text-label">Nginx</text>
                <text x="225" y="165" class="port-label">:80/:443</text>
                
                <!-- Service Layer -->
                <rect x="50" y="220" width="140" height="60" class="service-box"/>
                <text x="120" y="245" class="text-label">API Gateway</text>
                <text x="120" y="265" class="port-label">:3000</text>
                
                <rect x="210" y="220" width="140" height="60" class="service-box"/>
                <text x="280" y="245" class="text-label">Auth Service</text>
                <text x="280" y="265" class="port-label">:3001</text>
                
                <rect x="370" y="220" width="140" height="60" class="service-box"/>
                <text x="440" y="245" class="text-label">User Service</text>
                <text x="440" y="265" class="port-label">:3002</text>
                
                <rect x="530" y="220" width="140" height="60" class="service-box"/>
                <text x="600" y="245" class="text-label">Call Service</text>
                <text x="600" y="265" class="port-label">:3003</text>
                
                <rect x="50" y="320" width="140" height="60" class="service-box"/>
                <text x="120" y="345" class="text-label">Signaling Service</text>
                <text x="120" y="365" class="port-label">:3004</text>
                
                <rect x="210" y="320" width="140" height="60" class="service-box"/>
                <text x="280" y="345" class="text-label">Media Service</text>
                <text x="280" y="365" class="port-label">:3005</text>
                
                <rect x="370" y="320" width="140" height="60" class="service-box"/>
                <text x="440" y="345" class="text-label">Room Service</text>
                <text x="440" y="365" class="port-label">:3006</text>
                
                <!-- Media Processing -->
                <rect x="700" y="220" width="140" height="60" class="media-box"/>
                <text x="770" y="245" class="text-label">Kurento</text>
                <text x="770" y="265" class="port-label">:8888</text>
                
                <rect x="700" y="320" width="140" height="60" class="media-box"/>
                <text x="770" y="345" class="text-label">Coturn</text>
                <text x="770" y="365" class="port-label">:3478</text>
                
                <!-- Data Layer -->
                <rect x="50" y="450" width="140" height="60" class="data-box"/>
                <text x="120" y="475" class="text-label">MongoDB</text>
                <text x="120" y="495" class="port-label">:27017</text>
                
                <rect x="210" y="450" width="140" height="60" class="data-box"/>
                <text x="280" y="475" class="text-label">Redis</text>
                <text x="280" y="495" class="port-label">:6379</text>
                
                <!-- Monitoring -->
                <rect x="900" y="220" width="140" height="60" class="monitor-box"/>
                <text x="970" y="245" class="text-label">Prometheus</text>
                <text x="970" y="265" class="port-label">:9090</text>
                
                <rect x="900" y="320" width="140" height="60" class="monitor-box"/>
                <text x="970" y="345" class="text-label">Grafana</text>
                <text x="970" y="365" class="port-label">:3006</text>
                
                <!-- Connections -->
                <!-- Client to Nginx -->
                <line x1="125" y1="80" x2="225" y2="120" class="arrow" marker-end="url(#arrowhead2)"/>
                <line x1="325" y1="80" x2="225" y2="120" class="arrow" marker-end="url(#arrowhead2)"/>
                
                <!-- Nginx to Services -->
                <line x1="225" y1="180" x2="120" y2="220" class="arrow" marker-end="url(#arrowhead2)"/>
                <line x1="225" y1="180" x2="120" y2="320" class="arrow-websocket" marker-end="url(#arrowhead-ws2)"/>
                
                <!-- API Gateway to Services -->
                <line x1="120" y1="280" x2="280" y2="220" class="arrow" marker-end="url(#arrowhead2)"/>
                <line x1="120" y1="280" x2="440" y2="220" class="arrow" marker-end="url(#arrowhead2)"/>
                <line x1="120" y1="280" x2="600" y2="220" class="arrow" marker-end="url(#arrowhead2)"/>
                
                <!-- Services to Data -->
                <line x1="280" y1="280" x2="120" y2="450" class="arrow" marker-end="url(#arrowhead2)"/>
                <line x1="280" y1="280" x2="280" y2="450" class="arrow" marker-end="url(#arrowhead2)"/>
                <line x1="440" y1="280" x2="120" y2="450" class="arrow" marker-end="url(#arrowhead2)"/>
                <line x1="600" y1="280" x2="120" y2="450" class="arrow" marker-end="url(#arrowhead2)"/>
                <line x1="120" y1="380" x2="280" y2="450" class="arrow" marker-end="url(#arrowhead2)"/>
                <line x1="280" y1="380" x2="280" y2="450" class="arrow" marker-end="url(#arrowhead2)"/>
                
                <!-- Media connections -->
                <line x1="280" y1="340" x2="700" y2="250" class="arrow-media" marker-end="url(#arrowhead-media2)"/>
                <line x1="120" y1="340" x2="700" y2="350" class="arrow-websocket" marker-end="url(#arrowhead-ws2)"/>
                
                <!-- Monitoring connections -->
                <line x1="670" y1="250" x2="900" y2="250" class="arrow" marker-end="url(#arrowhead2)"/>
                <line x1="350" y1="350" x2="900" y2="350" class="arrow" marker-end="url(#arrowhead2)"/>
                <line x1="970" y1="320" x2="970" y2="280" class="arrow" marker-end="url(#arrowhead2)"/>
            </svg>
        </div>
        
        <div class="details-grid">
            <div class="service-detail">
                <h4>🔵 API Gateway</h4>
                <div class="tech-stack">
                    <strong>기술 스택:</strong>
                    <ul>
                        <li>Express.js + TypeScript</li>
                        <li>http-proxy-middleware</li>
                        <li>JWT validation</li>
                        <li>Rate limiting</li>
                        <li>Prometheus metrics</li>
                    </ul>
                </div>
                <div class="api-endpoints">
                    <strong>주요 엔드포인트:</strong>
                    <ul>
                        <li><code>GET /health</code> - 헬스체크</li>
                        <li><code>* /api/auth/*</code> - Auth Service 프록시</li>
                        <li><code>* /api/users/*</code> - User Service 프록시</li>
                        <li><code>* /api/calls/*</code> - Call Service 프록시</li>
                    </ul>
                </div>
            </div>
            
            <div class="service-detail">
                <h4>🔐 Auth Service</h4>
                <div class="tech-stack">
                    <strong>기술 스택:</strong>
                    <ul>
                        <li>Node.js + Express</li>
                        <li>MongoDB (사용자 인증 정보)</li>
                        <li>Redis (세션 관리)</li>
                        <li>bcrypt (비밀번호 해싱)</li>
                        <li>jsonwebtoken</li>
                    </ul>
                </div>
                <div class="api-endpoints">
                    <strong>주요 엔드포인트:</strong>
                    <ul>
                        <li><code>POST /register</code> - 회원가입</li>
                        <li><code>POST /login</code> - 로그인</li>
                        <li><code>POST /logout</code> - 로그아웃</li>
                        <li><code>POST /refresh</code> - 토큰 갱신</li>
                        <li><code>POST /verify</code> - 토큰 검증</li>
                    </ul>
                </div>
            </div>
            
            <div class="service-detail">
                <h4>👤 User Service</h4>
                <div class="tech-stack">
                    <strong>기술 스택:</strong>
                    <ul>
                        <li>Node.js + Express</li>
                        <li>MongoDB (사용자 프로필)</li>
                        <li>Redis (온라인 상태)</li>
                        <li>Multer (프로필 이미지)</li>
                    </ul>
                </div>
                <div class="api-endpoints">
                    <strong>주요 엔드포인트:</strong>
                    <ul>
                        <li><code>GET /profile/:userId</code> - 프로필 조회</li>
                        <li><code>PUT /profile</code> - 프로필 수정</li>
                        <li><code>GET /contacts</code> - 연락처 목록</li>
                        <li><code>POST /contacts</code> - 연락처 추가</li>
                        <li><code>GET /search</code> - 사용자 검색</li>
                    </ul>
                </div>
            </div>
            
            <div class="service-detail">
                <h4>📞 Call Service</h4>
                <div class="tech-stack">
                    <strong>기술 스택:</strong>
                    <ul>
                        <li>Node.js + Express</li>
                        <li>MongoDB (통화 기록)</li>
                        <li>Redis (활성 통화)</li>
                        <li>UUID (통화 ID 생성)</li>
                    </ul>
                </div>
                <div class="api-endpoints">
                    <strong>주요 엔드포인트:</strong>
                    <ul>
                        <li><code>POST /calls/initiate</code> - 통화 시작</li>
                        <li><code>PUT /calls/:callId/end</code> - 통화 종료</li>
                        <li><code>GET /calls/history</code> - 통화 기록</li>
                        <li><code>GET /calls/active</code> - 활성 통화</li>
                        <li><code>GET /calls/stats</code> - 통화 통계</li>
                    </ul>
                </div>
            </div>
            
            <div class="service-detail">
                <h4>📡 Signaling Service</h4>
                <div class="tech-stack">
                    <strong>기술 스택:</strong>
                    <ul>
                        <li>Node.js + Socket.io</li>
                        <li>Redis (Pub/Sub)</li>
                        <li>JWT (소켓 인증)</li>
                        <li>WebRTC 시그널링</li>
                    </ul>
                </div>
                <div class="api-endpoints">
                    <strong>WebSocket 이벤트:</strong>
                    <ul>
                        <li><code>offer</code> - SDP Offer 전송</li>
                        <li><code>answer</code> - SDP Answer 전송</li>
                        <li><code>ice-candidate</code> - ICE 후보 교환</li>
                        <li><code>call-user</code> - 통화 요청</li>
                        <li><code>accept-call</code> - 통화 수락</li>
                        <li><code>reject-call</code> - 통화 거절</li>
                        <li><code>end-call</code> - 통화 종료</li>
                    </ul>
                </div>
            </div>
            
            <div class="service-detail">
                <h4>🎥 Media Service</h4>
                <div class="tech-stack">
                    <strong>기술 스택:</strong>
                    <ul>
                        <li>Node.js + Express</li>
                        <li>Mediasoup / simple-peer</li>
                        <li>Kurento Client</li>
                        <li>FFmpeg</li>
                        <li>node-media-server</li>
                    </ul>
                </div>
                <div class="api-endpoints">
                    <strong>주요 기능:</strong>
                    <ul>
                        <li>WebRTC 엔드포인트 관리</li>
                        <li>미디어 파이프라인 생성</li>
                        <li>녹음/녹화 처리</li>
                        <li>트랜스코딩</li>
                        <li>품질 적응</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <h2>3. 각 서비스 상세 설계</h2>
        
        <div class="details-grid">
            <div class="service-detail">
                <h4>🔵 API Gateway</h4>
                <div class="tech-stack">
                    <strong>기술 스택:</strong>
                    <ul>
                        <li>Express.js + TypeScript</li>
                        <li>http-proxy-middleware</li>
                        <li>JWT validation</li>
                        <li>Rate limiting</li>
                        <li>Prometheus metrics</li>
                    </ul>
                </div>
                <div class="api-endpoints">
                    <strong>주요 엔드포인트:</strong>
                    <ul>
                        <li><code>GET /health</code> - 헬스체크</li>
                        <li><code>* /api/auth/*</code> - Auth Service 프록시</li>
                        <li><code>* /api/users/*</code> - User Service 프록시</li>
                        <li><code>* /api/calls/*</code> - Call Service 프록시</li>
                    </ul>
                </div>
            </div>
            
            <div class="service-detail">
                <h4>🔐 Auth Service</h4>
                <div class="tech-stack">
                    <strong>기술 스택:</strong>
                    <ul>
                        <li>Node.js + Express</li>
                        <li>MongoDB (사용자 인증 정보)</li>
                        <li>Redis (세션 관리)</li>
                        <li>bcrypt (비밀번호 해싱)</li>
                        <li>jsonwebtoken</li>
                    </ul>
                </div>
                <div class="api-endpoints">
                    <strong>주요 엔드포인트:</strong>
                    <ul>
                        <li><code>POST /register</code> - 회원가입</li>
                        <li><code>POST /login</code> - 로그인</li>
                        <li><code>POST /logout</code> - 로그아웃</li>
                        <li><code>POST /refresh</code> - 토큰 갱신</li>
                        <li><code>POST /verify</code> - 토큰 검증</li>
                    </ul>
                </div>
            </div>
            
            <div class="service-detail">
                <h4>👤 User Service</h4>
                <div class="tech-stack">
                    <strong>기술 스택:</strong>
                    <ul>
                        <li>Node.js + Express</li>
                        <li>MongoDB (사용자 프로필)</li>
                        <li>Redis (온라인 상태)</li>
                        <li>Multer (프로필 이미지)</li>
                    </ul>
                </div>
                <div class="api-endpoints">
                    <strong>주요 엔드포인트:</strong>
                    <ul>
                        <li><code>GET /profile/:userId</code> - 프로필 조회</li>
                        <li><code>PUT /profile</code> - 프로필 수정</li>
                        <li><code>GET /contacts</code> - 연락처 목록</li>
                        <li><code>POST /contacts</code> - 연락처 추가</li>
                        <li><code>GET /search</code> - 사용자 검색</li>
                    </ul>
                </div>
            </div>
            
            <div class="service-detail">
                <h4>📞 Call Service</h4>
                <div class="tech-stack">
                    <strong>기술 스택:</strong>
                    <ul>
                        <li>Node.js + Express</li>
                        <li>MongoDB (통화 기록)</li>
                        <li>Redis (활성 통화)</li>
                        <li>UUID (통화 ID 생성)</li>
                    </ul>
                </div>
                <div class="api-endpoints">
                    <strong>주요 엔드포인트:</strong>
                    <ul>
                        <li><code>POST /calls/initiate</code> - 통화 시작</li>
                        <li><code>PUT /calls/:callId/end</code> - 통화 종료</li>
                        <li><code>GET /calls/history</code> - 통화 기록</li>
                        <li><code>GET /calls/active</code> - 활성 통화</li>
                        <li><code>GET /calls/stats</code> - 통화 통계</li>
                    </ul>
                </div>
            </div>
            
            <div class="service-detail">
                <h4>📡 Signaling Service</h4>
                <div class="tech-stack">
                    <strong>기술 스택:</strong>
                    <ul>
                        <li>Node.js + Socket.io</li>
                        <li>Redis (Pub/Sub)</li>
                        <li>JWT (소켓 인증)</li>
                        <li>WebRTC 시그널링</li>
                    </ul>
                </div>
                <div class="api-endpoints">
                    <strong>WebSocket 이벤트:</strong>
                    <ul>
                        <li><code>offer</code> - SDP Offer 전송</li>
                        <li><code>answer</code> - SDP Answer 전송</li>
                        <li><code>ice-candidate</code> - ICE 후보 교환</li>
                        <li><code>call-user</code> - 통화 요청</li>
                        <li><code>accept-call</code> - 통화 수락</li>
                        <li><code>reject-call</code> - 통화 거절</li>
                        <li><code>end-call</code> - 통화 종료</li>
                    </ul>
                </div>
            </div>
            
            <div class="service-detail">
                <h4>🎥 Media Service</h4>
                <div class="tech-stack">
                    <strong>기술 스택:</strong>
                    <ul>
                        <li>Node.js + Express</li>
                        <li>Mediasoup / simple-peer</li>
                        <li>Kurento Client</li>
                        <li>FFmpeg</li>
                        <li>node-media-server</li>
                    </ul>
                </div>
                <div class="api-endpoints">
                    <strong>주요 기능:</strong>
                    <ul>
                        <li>WebRTC 엔드포인트 관리</li>
                        <li>미디어 파이프라인 생성</li>
                        <li>녹음/녹화 처리</li>
                        <li>트랜스코딩</li>
                        <li>품질 적응</li>
                    </ul>
                </div>
            </div>
            
            <div class="service-detail">
                <h4>🏠 Room Service</h4>
                <div class="tech-stack">
                    <strong>기술 스택:</strong>
                    <ul>
                        <li>Node.js + Express</li>
                        <li>Redis (룸 상태)</li>
                        <li>Socket.io (실시간 이벤트)</li>
                    </ul>
                </div>
                <div class="api-endpoints">
                    <strong>주요 기능:</strong>
                    <ul>
                        <li>그룹 통화룸 생성/관리</li>
                        <li>참가자 권한 관리</li>
                        <li>화면 공유 조정</li>
                        <li>룸 설정 관리</li>
                    </ul>
                </div>
            </div>
            
            <div class="service-detail">
                <h4>📊 Monitoring Services</h4>
                <div class="tech-stack">
                    <strong>Prometheus:</strong>
                    <ul>
                        <li>메트릭 수집</li>
                        <li>알림 규칙 정의</li>
                        <li>시계열 데이터 저장</li>
                    </ul>
                    <strong>Grafana:</strong>
                    <ul>
                        <li>실시간 대시보드</li>
                        <li>시각화 및 차트</li>
                        <li>알림 관리</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <h2>4. 데이터 모델</h2>
        
        <h3>4.1 MongoDB 스키마</h3>
        
        <div class="data-model">
            <h4>Users Collection</h4>
            <pre>{
  _id: ObjectId,
  email: String (unique, indexed),
  password: String (bcrypt hashed),
  profile: {
    name: String,
    avatar: String (S3 URL),
    bio: String,
    phoneNumber: String
  },
  settings: {
    notifications: Boolean,
    privacy: {
      showOnlineStatus: Boolean,
      allowCalls: String (everyone/contacts/nobody)
    }
  },
  contacts: [ObjectId],
  blockedUsers: [ObjectId],
  createdAt: Date,
  updatedAt: Date
}</pre>
        </div>
        
        <div class="data-model">
            <h4>Calls Collection</h4>
            <pre>{
  _id: ObjectId,
  callId: String (unique, indexed),
  participants: [{
    userId: ObjectId,
    role: String (caller/callee),
    joinedAt: Date,
    leftAt: Date
  }],
  type: String (audio/video/screen),
  status: String (initiated/ringing/active/ended/failed),
  startTime: Date,
  endTime: Date,
  duration: Number (seconds),
  quality: {
    avgBitrate: Number,
    packetLoss: Number,
    jitter: Number
  },
  recording: {
    enabled: Boolean,
    url: String,
    size: Number
  },
  metadata: Object
}</pre>
        </div>
        
        <h3>4.2 Redis 데이터 구조</h3>
        
        <table>
            <thead>
                <tr>
                    <th>Key Pattern</th>
                    <th>Type</th>
                    <th>Description</th>
                    <th>TTL</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>user:session:{userId}</code></td>
                    <td>String</td>
                    <td>JWT 토큰</td>
                    <td>24시간</td>
                </tr>
                <tr>
                    <td><code>user:status:{userId}</code></td>
                    <td>Hash</td>
                    <td>온라인 상태 정보</td>
                    <td>없음</td>
                </tr>
                <tr>
                    <td><code>call:active:{callId}</code></td>
                    <td>Hash</td>
                    <td>활성 통화 정보</td>
                    <td>1시간</td>
                </tr>
                <tr>
                    <td><code>user:socket:{userId}</code></td>
                    <td>String</td>
                    <td>Socket ID 매핑</td>
                    <td>연결 중</td>
                </tr>
                <tr>
                    <td><code>room:participants:{roomId}</code></td>
                    <td>Set</td>
                    <td>룸 참가자 목록</td>
                    <td>2시간</td>
                </tr>
            </tbody>
        </table>
        
        <h2>5. 통화 플로우 상세</h2>
        
        <h3>5.1 1:1 음성 통화 시작 플로우</h3>
        
        <div class="sequence-diagram">
            <div class="flow-step" data-step="1">
                <strong>클라이언트 초기화</strong>
                <p>발신자가 통화 버튼 클릭 → getUserMedia() 호출 → 마이크 권한 요청</p>
            </div>
            
            <div class="flow-step" data-step="2">
                <strong>API 요청</strong>
                <p>POST /api/calls/initiate → JWT 토큰 검증 → 수신자 상태 확인</p>
            </div>
            
            <div class="flow-step" data-step="3">
                <strong>WebSocket 연결</strong>
                <p>Socket.io 연결 → 인증 → call-user 이벤트 발송</p>
            </div>
            
            <div class="flow-step" data-step="4">
                <strong>시그널링 서버 처리</strong>
                <p>수신자 소켓 찾기 → incoming-call 이벤트 전송 → Redis 상태 업데이트</p>
            </div>
            
            <div class="flow-step" data-step="5">
                <strong>수신자 알림</strong>
                <p>벨소리 재생 → 통화 수락/거절 UI 표시</p>
            </div>
            
            <div class="flow-step" data-step="6">
                <strong>WebRTC 협상</strong>
                <p>RTCPeerConnection 생성 → createOffer() → setLocalDescription() → offer 전송</p>
            </div>
            
            <div class="flow-step" data-step="7">
                <strong>Answer 생성</strong>
                <p>수신자 createAnswer() → setLocalDescription() → answer 전송</p>
            </div>
            
            <div class="flow-step" data-step="8">
                <strong>ICE 협상</strong>
                <p>STUN 서버 조회 → ICE candidates 수집 → 교환 → 연결 확립</p>
            </div>
            
            <div class="flow-step" data-step="9">
                <strong>미디어 스트림</strong>
                <p>P2P 또는 TURN 릴레이 → 오디오 패킷 전송 시작</p>
            </div>
            
            <div class="flow-step" data-step="10">
                <strong>통화 활성화</strong>
                <p>Call Service 상태 업데이트 → 통화 시간 측정 시작</p>
            </div>
        </div>
        
        <h2>6. 네트워크 구성</h2>
        
        <div class="network-info">
            <h3>6.1 Docker 네트워크</h3>
            <table>
                <thead>
                    <tr>
                        <th>네트워크</th>
                        <th>타입</th>
                        <th>서비스</th>
                        <th>설명</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>voip-network</td>
                        <td>bridge</td>
                        <td>모든 서비스</td>
                        <td>내부 통신용 브리지 네트워크</td>
                    </tr>
                    <tr>
                        <td>host</td>
                        <td>host</td>
                        <td>Coturn</td>
                        <td>NAT 순회를 위한 호스트 네트워크</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <h3>6.2 포트 매핑</h3>
        <table>
            <thead>
                <tr>
                    <th>서비스</th>
                    <th>내부 포트</th>
                    <th>외부 포트</th>
                    <th>프로토콜</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Nginx</td>
                    <td>80, 443</td>
                    <td>80, 443</td>
                    <td>HTTP/HTTPS</td>
                </tr>
                <tr>
                    <td>API Gateway</td>
                    <td>3000</td>
                    <td>-</td>
                    <td>HTTP</td>
                </tr>
                <tr>
                    <td>Auth Service</td>
                    <td>3001</td>
                    <td>-</td>
                    <td>HTTP</td>
                </tr>
                <tr>
                    <td>User Service</td>
                    <td>3002</td>
                    <td>-</td>
                    <td>HTTP</td>
                </tr>
                <tr>
                    <td>Call Service</td>
                    <td>3003</td>
                    <td>-</td>
                    <td>HTTP</td>
                </tr>
                <tr>
                    <td>Signaling Service</td>
                    <td>3004</td>
                    <td>-</td>
                    <td>WebSocket</td>
                </tr>
                <tr>
                    <td>Media Service</td>
                    <td>3005</td>
                    <td>-</td>
                    <td>HTTP</td>
                </tr>
                <tr>
                    <td>MongoDB</td>
                    <td>27017</td>
                    <td>27017</td>
                    <td>TCP</td>
                </tr>
                <tr>
                    <td>Redis</td>
                    <td>6379</td>
                    <td>6379</td>
                    <td>TCP</td>
                </tr>
                <tr>
                    <td>Kurento</td>
                    <td>8888</td>
                    <td>8888</td>
                    <td>WebSocket</td>
                </tr>
                <tr>
                    <td>Coturn</td>
                    <td>3478</td>
                    <td>3478</td>
                    <td>UDP/TCP</td>
                </tr>
                <tr>
                    <td>Coturn (TLS)</td>
                    <td>5349</td>
                    <td>5349</td>
                    <td>UDP/TCP</td>
                </tr>
                <tr>
                    <td>Kurento RTP</td>
                    <td>40000-50000</td>
                    <td>40000-50000</td>
                    <td>UDP</td>
                </tr>
            </tbody>
        </table>
        
        <h2>7. 보안 아키텍처</h2>
        
        <h3>7.1 인증/인가 플로우</h3>
        
        <div class="architecture-diagram">
            <svg viewBox="0 0 800 400" xmlns="http://www.w3.org/2000/svg">
                <!-- Client -->
                <rect x="50" y="50" width="100" height="50" class="client-box"/>
                <text x="100" y="80" class="text-label">Client</text>
                
                <!-- API Gateway -->
                <rect x="250" y="50" width="100" height="50" class="gateway-box"/>
                <text x="300" y="80" class="text-label">API GW</text>
                
                <!-- Auth Service -->
                <rect x="450" y="50" width="100" height="50" class="service-box"/>
                <text x="500" y="80" class="text-label">Auth</text>
                
                <!-- Redis -->
                <rect x="450" y="150" width="100" height="50" class="data-box"/>
                <text x="500" y="180" class="text-label">Redis</text>
                
                <!-- Service -->
                <rect x="650" y="50" width="100" height="50" class="service-box"/>
                <text x="700" y="80" class="text-label">Service</text>
                
                <!-- Flow arrows with labels -->
                <line x1="150" y1="75" x2="250" y2="75" class="arrow"/>
                <text x="175" y="70" font-size="12">1. Request + JWT</text>
                
                <line x1="350" y1="75" x2="450" y2="75" class="arrow"/>
                <text x="375" y="70" font-size="12">2. Verify</text>
                
                <line x1="500" y1="100" x2="500" y2="150" class="arrow"/>
                <text x="510" y="125" font-size="12">3. Check</text>
                
                <line x1="450" y1="75" x2="350" y2="75" class="arrow" stroke-dasharray="5,5"/>
                <text x="375" y="90" font-size="12">4. Valid</text>
                
                <line x1="550" y1="75" x2="650" y2="75" class="arrow"/>
                <text x="575" y="70" font-size="12">5. Forward</text>
                
                <line x1="650" y1="75" x2="150" y2="75" class="arrow" stroke-dasharray="5,5" 
                      marker-end="url(#arrowhead)" 
                      d="M 650 75 Q 400 250 150 75"/>
                <text x="400" y="200" font-size="12">6. Response</text>
            </svg>
        </div>
        
        <h3>7.2 보안 계층</h3>
        
        <table>
            <thead>
                <tr>
                    <th>계층</th>
                    <th>보안 기술</th>
                    <th>목적</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>네트워크</td>
                    <td>SSL/TLS, VPN</td>
                    <td>전송 중 암호화</td>
                </tr>
                <tr>
                    <td>애플리케이션</td>
                    <td>JWT, OAuth 2.0</td>
                    <td>인증/인가</td>
                </tr>
                <tr>
                    <td>API</td>
                    <td>Rate Limiting, CORS</td>
                    <td>API 보호</td>
                </tr>
                <tr>
                    <td>미디어</td>
                    <td>DTLS-SRTP</td>
                    <td>미디어 스트림 암호화</td>
                </tr>
                <tr>
                    <td>데이터</td>
                    <td>암호화, 해싱</td>
                    <td>저장 데이터 보호</td>
                </tr>
            </tbody>
        </table>
        
        <h2>8. 확장성 및 성능 최적화</h2>
        
        <h3>8.1 수평 확장 전략</h3>
        
        <div class="service-detail">
            <h4>서비스별 스케일링</h4>
            <ul>
                <li><strong>API Gateway:</strong> 로드 밸런서 뒤에 여러 인스턴스 배치</li>
                <li><strong>Auth Service:</strong> Stateless 설계로 자유로운 확장</li>
                <li><strong>Signaling Service:</strong> Redis Pub/Sub로 인스턴스 간 동기화</li>
                <li><strong>Media Service:</strong> 지역별 분산 배치</li>
                <li><strong>MongoDB:</strong> 복제셋 및 샤딩</li>
                <li><strong>Redis:</strong> 클러스터 모드</li>
            </ul>
        </div>
        
        <h3>8.2 캐싱 전략</h3>
        
        <table>
            <thead>
                <tr>
                    <th>캐시 레벨</th>
                    <th>대상 데이터</th>
                    <th>TTL</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>CDN</td>
                    <td>정적 자원 (JS, CSS, 이미지)</td>
                    <td>1년</td>
                </tr>
                <tr>
                    <td>Redis</td>
                    <td>세션, 사용자 상태</td>
                    <td>24시간</td>
                </tr>
                <tr>
                    <td>Application</td>
                    <td>자주 조회되는 프로필</td>
                    <td>5분</td>
                </tr>
                <tr>
                    <td>Database</td>
                    <td>쿼리 결과</td>
                    <td>1분</td>
                </tr>
            </tbody>
        </table>
        
        <h2>9. 모니터링 및 로깅</h2>
        
        <h3>9.1 모니터링 메트릭</h3>
        
        <div class="details-grid">
            <div class="service-detail">
                <h4>시스템 메트릭</h4>
                <ul>
                    <li>CPU 사용률</li>
                    <li>메모리 사용량</li>
                    <li>디스크 I/O</li>
                    <li>네트워크 트래픽</li>
                </ul>
            </div>
            
            <div class="service-detail">
                <h4>애플리케이션 메트릭</h4>
                <ul>
                    <li>요청 응답 시간</li>
                    <li>에러율</li>
                    <li>활성 연결 수</li>
                    <li>통화 품질 지표</li>
                </ul>
            </div>
            
            <div class="service-detail">
                <h4>비즈니스 메트릭</h4>
                <ul>
                    <li>동시 통화 수</li>
                    <li>일일 활성 사용자</li>
                    <li>평균 통화 시간</li>
                    <li>통화 성공률</li>
                </ul>
            </div>
        </div>
        
        <h3>9.2 로그 수집 파이프라인</h3>
        
        <div class="flow-step">
            각 서비스 → Filebeat → Logstash → Elasticsearch → Kibana
        </div>
        
        <h2>10. 배포 전략</h2>
        
        <h3>10.1 CI/CD 파이프라인</h3>
        
        <div class="sequence-diagram">
            <div class="flow-step" data-step="1">
                <strong>코드 커밋</strong>
                <p>Git push → GitHub webhook 트리거</p>
            </div>
            
            <div class="flow-step" data-step="2">
                <strong>빌드</strong>
                <p>Docker 이미지 빌드 → 유닛 테스트 실행</p>
            </div>
            
            <div class="flow-step" data-step="3">
                <strong>테스트</strong>
                <p>통합 테스트 → E2E 테스트 → 보안 스캔</p>
            </div>
            
            <div class="flow-step" data-step="4">
                <strong>스테이징 배포</strong>
                <p>스테이징 환경 배포 → 스모크 테스트</p>
            </div>
            
            <div class="flow-step" data-step="5">
                <strong>프로덕션 배포</strong>
                <p>Blue-Green 배포 → 헬스체크 → 트래픽 전환</p>
            </div>
        </div>
        
        <h3>10.2 환경별 구성</h3>
        
        <table>
            <thead>
                <tr>
                    <th>환경</th>
                    <th>용도</th>
                    <th>인프라</th>
                    <th>데이터</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Development</td>
                    <td>개발 및 테스트</td>
                    <td>Docker Compose</td>
                    <td>로컬 DB</td>
                </tr>
                <tr>
                    <td>Staging</td>
                    <td>통합 테스트</td>
                    <td>Kubernetes (소규모)</td>
                    <td>테스트 데이터</td>
                </tr>
                <tr>
                    <td>Production</td>
                    <td>실제 서비스</td>
                    <td>Kubernetes (대규모)</td>
                    <td>실제 데이터</td>
                </tr>
            </tbody>
        </table>
    </div>
</body>
</html>